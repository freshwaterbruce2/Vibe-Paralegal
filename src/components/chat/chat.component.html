<div #chatContainer class="flex-grow p-6 overflow-y-auto">
  <div class="flex flex-col space-y-4">
    @for (message of messages(); track $index) {
      <div class="flex" [class.justify-end]="message.role === 'user'" [class.justify-start]="message.role === 'model'">
        <div class="max-w-3xl px-4 py-3 rounded-xl" [class.bg-blue-600]="message.role === 'user'" [class.bg-gray-700]="message.role === 'model'">
          @if (message.role === 'model') {
            <div class="prose prose-sm max-w-none prose-invert" [innerHTML]="formatMessageText(message.text)"></div>
          } @else {
            <p class="text-white">{{ message.text }}</p>
          }
        </div>
      </div>
    }
    @if (loading() && messages()[messages().length - 1]?.text === '') {
      <div class="flex justify-start">
         <div class="max-w-3xl px-4 py-3 rounded-xl bg-gray-700 flex items-center space-x-2">
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
        </div>
      </div>
    }
  </div>
</div>

@if (error()) {
  <div class="px-6 pb-2">
    <div class="bg-red-500/20 border border-red-500 text-red-300 px-4 py-3 rounded-md" role="alert">
      <p>{{ error() }}</p>
    </div>
  </div>
}

<div class="p-6 border-t border-gray-700 bg-gray-900/50">
  <form class="flex items-center space-x-4" (submit)="$event.preventDefault(); sendMessage()">
    <textarea
      class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none text-gray-200 placeholder-gray-400 disabled:opacity-50"
      placeholder="Ask a question or describe the focus of your action plan..."
      rows="1"
      [value]="chatPrompt()"
      (input)="handlePromptInput($event)"
      (keydown.enter)="handleKeydownEnter($event)"
      [disabled]="loading()"
    ></textarea>
    <button
      type="button"
      (click)="generateActionPlan()"
      class="bg-gray-600 text-gray-200 p-3 rounded-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-500 disabled:bg-gray-700 disabled:cursor-not-allowed transition-colors duration-200"
      [disabled]="loading()"
      title="Generate Action Plan"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
      </svg>
    </button>
    <button
      type="submit"
      class="bg-blue-600 text-white p-3 rounded-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-500 disabled:bg-blue-800 disabled:cursor-not-allowed transition-colors duration-200"
      [disabled]="loading() || !chatPrompt().trim()"
      title="Send Message"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform -rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
      </svg>
    </button>
  </form>
</div>
